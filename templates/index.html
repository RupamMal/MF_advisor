<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Mutual Fund Advisor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #2c3e50; --secondary-color: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .main-container { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); margin: 20px auto; max-width: 1200px; }
        .header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 2rem; border-radius: 20px 20px 0 0; text-align: center; }
        .form-section, .top-funds-section, .results-section { padding: 2rem; }
        .card { border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .card-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 15px 15px 0 0 !important; }
        .loading { display: none; text-align: center; padding: 2rem; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .risk-profile { padding: 1rem; border-radius: 10px; text-align: center; font-weight: bold; }
        .risk-low { background: #d4edda; color: #155724; }
        .risk-moderate { background: #fff3cd; color: #856404; }
        .risk-high { background: #f8d7da; color: #721c24; }
        .fund-card { border-left: 4px solid var(--secondary-color); margin-bottom: 1rem; }
        .metric-badge { background: #ecf0f1; color: var(--primary-color); padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; margin: 2px; display: inline-block; }
        .insight-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 1.5rem; margin: 1rem 0; }
        pre { white-space: pre-wrap; background: #f8f9fa; border: 1px solid #dee2e6; padding: 1rem; border-radius: 5px; font-size: 0.8rem; color: #333; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> Your Mutual Fund Advisor</h1>
                <p>Get personalized mutual fund recommendations based on your complete profile.</p>
                <p class="mb-0 mt-2">Made withüíù, by Rupam</p>
            </div>

            <!-- Navigation -->
            <div class="nav-section p-4">
                <div class="row">
                    <div class="col-md-6 mb-2 mb-md-0"><button class="btn btn-outline-primary btn-lg w-100" id="personalizedBtn"><i class="fas fa-user-cog"></i> Get Personalized Recommendations</button></div>
                    <div class="col-md-6"><button class="btn btn-outline-success btn-lg w-100" id="topFundsBtn"><i class="fas fa-trophy"></i> View Top 5 Funds</button></div>
                </div>
            </div>

            <!-- Input Form Section (FULL DETAILED VERSION) -->
            <div class="form-section" id="inputForm">
                <form id="recommendationForm">
                     <div class="row">
                        <div class="col-md-6 mb-3"><label for="name" class="form-label">Full Name</label><input type="text" class="form-control" id="name" required></div>
                        <div class="col-md-6 mb-3"><label for="age" class="form-label">Age</label><input type="number" class="form-control" id="age" min="18" max="100" required></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="annualIncome" class="form-label">Annual Income (‚Çπ)</label><input type="number" class="form-control" id="annualIncome" min="100000" required></div>
                        <div class="col-md-6 mb-3"><label for="investmentAmount" class="form-label">Total Lumpsum Investment (‚Çπ)</label><input type="number" class="form-control" id="investmentAmount" min="1000" required></div>
                    </div>
                    <div class="row">
                         <div class="col-md-6 mb-3"><label for="riskTolerance" class="form-label">Risk Appetite</label><select class="form-select" id="riskTolerance"><option value="low">Conservative</option><option value="moderate" selected>Moderate</option><option value="high">Aggressive</option></select></div>
                         <div class="col-md-6 mb-3"><label for="investmentGoal" class="form-label">Investment Goal</label><select class="form-select" id="investmentGoal"><option value="retirement">Retirement Planning</option><option value="child_education">Child Education</option><option value="wealth_creation" selected>Wealth Creation</option><option value="tax_saving">Tax Saving</option></select></div>
                    </div>
                     <div class="row">
                         <div class="col-md-6 mb-3"><label for="investmentHorizon" class="form-label">Investment Horizon (Years)</label><select class="form-select" id="investmentHorizon"><option value="1-3">1-3 years</option><option value="3-5">3-5 years</option><option value="5-10" selected>5-10 years</option><option value="10+">10+ years</option></select></div>
                         <div class="col-md-6 mb-3"><label for="monthlySIP" class="form-label">Monthly SIP Budget (‚Çπ)</label><input type="number" class="form-control" id="monthlySIP" min="500" placeholder="e.g., 5000"></div>
                     </div>
                     <div class="row">
                         <div class="col-md-6 mb-3"><label for="existingInvestments" class="form-label">Existing Investments (‚Çπ)</label><input type="number" class="form-control" id="existingInvestments" value="0" min="0"></div>
                         <div class="col-md-6 mb-3"><label for="taxBracket" class="form-label">Tax Bracket</label><select class="form-select" id="taxBracket"><option value="0">0%</option><option value="10">10%</option><option value="20">20%</option><option value="30" selected>30%</option></select></div>
                     </div>
                     <div class="row">
                         <div class="col-md-6 mb-3"><label for="emergencyFund" class="form-label">Emergency Fund Status</label><select class="form-select" id="emergencyFund"><option value="yes" selected>Fully funded</option><option value="no">Need to build</option><option value="partial">Partially funded</option></select></div>
                         <div class="col-md-6 mb-3"><label for="fundTypePreference" class="form-label">Fund Plan Preference</label><select class="form-select" id="fundTypePreference"><option value="direct" selected>Direct Plan</option><option value="regular">Regular Plan</option></select></div>
                     </div>
                     <div class="row">
                         <div class="col-md-6 mb-3"><label for="esgPreference" class="form-label">ESG Preference</label><select class="form-select" id="esgPreference"><option value="no_preference" selected>No preference</option><option value="esg_focused">ESG-focused</option></select></div>
                         <div class="col-md-6 mb-3"><label for="dividendPreference" class="form-label">Dividend vs Growth</label><select class="form-select" id="dividendPreference"><option value="growth" selected>Growth</option><option value="dividend">Dividend</option></select></div>
                     </div>
                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-magic"></i> Get Recommendations</button>
                    </div>
                </form>
            </div>

            <!-- All other sections (Loading, Top Funds, Results) remain the same -->
            <div class="loading" id="loading"><div class="spinner mb-3"></div><h4>Analyzing your profile...</h4></div>
            <div class="top-funds-section" id="topFundsSection" style="display: none;"><div class="card"><div class="card-header"><h5><i class="fas fa-trophy"></i> Top 5 Mutual Funds</h5></div><div class="card-body"><div class="btn-group w-100 mb-3" role="group"><input type="radio" class="btn-check" name="fundCategory" id="largeCap" value="large_cap" checked><label class="btn btn-outline-primary" for="largeCap">Large</label><input type="radio" class="btn-check" name="fundCategory" id="midCap" value="mid_cap"><label class="btn btn-outline-primary" for="midCap">Mid</label><input type="radio" class="btn-check" name="fundCategory" id="flexiCap" value="flexi_cap"><label class="btn btn-outline-primary" for="flexiCap">Flexi</label><input type="radio" class="btn-check" name="fundCategory" id="smallCap" value="small_cap"><label class="btn btn-outline-primary" for="smallCap">Small</label></div><div id="topFundsContent"></div></div></div></div>
            <div class="results-section" id="resultsSection" style="display: none;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- Navigation Logic ---
        const inputForm = document.getElementById('inputForm');
        const topFundsSection = document.getElementById('topFundsSection');
        const resultsSection = document.getElementById('resultsSection');
        const loadingSection = document.getElementById('loading');
        document.getElementById('personalizedBtn').addEventListener('click', () => { inputForm.style.display = 'block'; topFundsSection.style.display = 'none'; resultsSection.style.display = 'none'; });
        document.getElementById('topFundsBtn').addEventListener('click', () => { inputForm.style.display = 'none'; topFundsSection.style.display = 'block'; resultsSection.style.display = 'none'; loadTopFunds('large_cap'); });

        // --- Top Funds Logic ---
        document.querySelectorAll('input[name="fundCategory"]').forEach(radio => radio.addEventListener('change', (e) => loadTopFunds(e.target.value)));
        async function loadTopFunds(category) {
            const contentDiv = document.getElementById('topFundsContent');
            contentDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            try {
                const response = await fetch('/top-funds', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ category }) });
                const data = await response.json();
                if (data.success) { displayTopFunds(data.funds); } 
                else { contentDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${data.error}</div>`; }
            } catch (error) { contentDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`; }
        }
        function displayTopFunds(funds) {
            const container = document.getElementById('topFundsContent');
            if (!funds || funds.length === 0) { container.innerHTML = '<p class="text-center">No funds found.</p>'; return; }
            container.innerHTML = funds.map((fund, index) => `
                <div class="fund-card p-3 mb-2"><h6><span class="badge bg-primary me-2">#${index+1}</span>${fund.name||'N/A'}</h6><div>
                <span class="metric-badge">5Y: ${fund.sip_5yr_return?.toFixed(2)??'N/A'}%</span>
                <span class="metric-badge">Expense: ${fund.expense_ratio?.toFixed(2)??'N/A'}%</span>
                <span class="metric-badge">Score: ${fund.score?.toFixed(2)??'N/A'}</span>
                <a href="${fund.grow_url||'#'}" target="_blank" class="btn btn-sm btn-success float-end">View</a></div></div>`).join('');
        }

        // --- Main Form Submission ---
        document.getElementById('recommendationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            inputForm.style.display = 'none';
            loadingSection.style.display = 'block';
            resultsSection.style.display = 'none';
            
            // --- Collect ALL data from the detailed form ---
            const formData = {
                name: document.getElementById('name').value,
                age: document.getElementById('age').value,
                annual_income: document.getElementById('annualIncome').value,
                investment_amount: document.getElementById('investmentAmount').value,
                risk_tolerance: document.getElementById('riskTolerance').value,
                investment_goal: document.getElementById('investmentGoal').value,
                investment_horizon: document.getElementById('investmentHorizon').value,
                monthly_sip: document.getElementById('monthlySIP').value,
                existing_investments: document.getElementById('existingInvestments').value,
                tax_bracket: document.getElementById('taxBracket').value,
                emergency_fund: document.getElementById('emergencyFund').value,
                fund_type_preference: document.getElementById('fundTypePreference').value,
                esg_preference: document.getElementById('esgPreference').value,
                dividend_preference: document.getElementById('dividendPreference').value,
            };

            try {
                const response = await fetch('/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                displayResults({ success: false, error: `Network error: ${error.message}` });
            } finally {
                loadingSection.style.display = 'none';
                resultsSection.style.display = 'block';
            }
        });

        // --- Bulletproof Results Display Function ---
        function displayResults(data) {
            const container = document.getElementById('resultsSection');
            if (data.success !== true) {
                let errorMessage = `<p><strong>Error:</strong> ${data.error || 'Unknown error.'}</p>`;
                if (data.debug_traceback) { errorMessage += `<h6>Details:</h6><pre>${data.debug_traceback}</pre>`; }
                container.innerHTML = `<div class="card"><div class="card-header bg-danger text-white"><h5>Application Error</h5></div><div class="card-body">${errorMessage}</div></div>`;
                return;
            }
            const { user_info = {}, recommendations = {}, llm_analysis = {} } = data;
            const riskValue = recommendations.risk_profile;
            let html = `
                <div class="card"><div class="card-header"><h5><i class="fas fa-user"></i> Profile</h5></div><div class="card-body">
                <p><strong>Name:</strong> ${user_info.name||'N/A'}</p>
                <p><strong>Investment:</strong> ‚Çπ${user_info.investment_amount?.toLocaleString()||'N/A'}</p>
                ${riskValue ? `<div class="risk-profile risk-${riskValue}">${riskValue.toUpperCase()} RISK</div>` : ''}</div></div>
                <div class="card"><div class="card-header"><h5><i class="fas fa-brain"></i> AI Summary</h5></div><div class="card-body">${llm_analysis.summary||'<p>Summary not available.</p>'}</div></div>`;
            if (llm_analysis.key_insights && llm_analysis.key_insights.length > 0) {
                html += `<div class="card"><div class="card-header"><h5><i class="fas fa-lightbulb"></i> Insights</h5></div><div class="card-body">
                ${llm_analysis.key_insights.map(insight => `<div class="insight-card p-3 mb-2">${insight}</div>`).join('')}</div></div>`;
            }
            if (recommendations.recommendations) {
                html += `<div class="card"><div class="card-header"><h5><i class="fas fa-stream"></i> Funds</h5></div><div class="card-body">`;
                for (const [category, funds] of Object.entries(recommendations.recommendations)) {
                    if (funds && funds.length > 0) {
                        html += `<h6>${category.replace(/_/g, ' ').toUpperCase()}</h6>`;
                        html += funds.map(fund => `<div class="fund-card p-3 mb-2"><strong>${fund.name||'N/A'}</strong><div>
                        <span class="metric-badge">5Y: ${fund.sip_5yr_return?.toFixed(2)??'N/A'}%</span>
                        <span class="metric-badge">Exp: ${fund.expense_ratio?.toFixed(2)??'N/A'}%</span>
                        <a href="${fund.grow_url||'#'}" target="_blank" class="btn btn-sm btn-success float-end">View</a></div></div>`).join('');
                    }
                }
                html += `</div></div>`;
            }
            container.innerHTML = html;
        }
    </script>
</body>
</html>
